// ===========================================
// CRMPro - Prisma Schema
// Multi-tenant SaaS CRM
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// BETTER AUTH MODELS
// Estos modelos son requeridos por Better Auth
// ===========================================

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // GitHub Integration (CRMDev)
  githubId       String?   @unique
  githubUsername String?
  avatarUrl      String?
  isVerifiedDev  Boolean   @default(false)

  // Relations
  sessions      Session[]
  accounts      Account[]
  members       Member[]
  sentInvitations Invitation[] @relation("InvitationSender")

  // CRM Relations
  assignedTasks Task[]    @relation("TaskAssignee")
  createdDeals  Deal[]    @relation("DealCreator")
  createdTasks  Task[]    @relation("TaskCreator")
  activities    Activity[]
  timeEntries   TimeEntry[]
  projectMembers ProjectMember[]
  ticketComments TicketComment[] @relation("TicketCommentAuthor")

  @@map("users")
}

model Session {
  id                   String    @id @default(cuid())
  expiresAt            DateTime
  token                String    @unique
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  ipAddress            String?
  userAgent            String?
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Better Auth Organization - Active organization for this session
  activeOrganizationId String?

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ===========================================
// BETTER AUTH ORGANIZATION MODELS
// Multi-tenancy con plugin organization
// ===========================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members       Member[]
  invitations   Invitation[]

  // CRM Data (todo filtrado por organizationId)
  clients       Client[]
  deals         Deal[]
  projects      Project[]
  tasks         Task[]
  customFields  CustomField[]
  pipelineStages PipelineStage[]
  activities    Activity[]
  timeEntries   TimeEntry[]
  tickets       Ticket[]

  // Billing
  subscription  Subscription?

  @@map("organizations")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member") // owner, admin, member
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("members")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String       @default("member")
  status         String       @default("pending") // pending, accepted, expired
  expiresAt      DateTime
  inviterId      String
  inviter        User         @relation("InvitationSender", fields: [inviterId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([email])
  @@map("invitations")
}

// ===========================================
// CRM MODELS
// Todos incluyen organizationId para multi-tenancy
// ===========================================

model Client {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  name           String
  email          String?
  phone          String?
  company        String?
  position       String?
  website        String?

  // Address
  address        String?
  city           String?
  state          String?
  country        String?
  postalCode     String?

  // CRM Fields
  status         ClientStatus @default(LEAD)
  source         String?      // web, referral, linkedin, etc.
  tags           String[]     @default([])
  notes          String?

  // Custom Fields (JSON para flexibilidad)
  customData     Json?

  // Metadata
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  deals          Deal[]
  projects       Project[]
  activities     Activity[]
  tickets        Ticket[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, email])
  @@map("clients")
}

enum ClientStatus {
  LEAD
  PROSPECT
  CUSTOMER
  INACTIVE
  CHURNED
}

model PipelineStage {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  color          String       @default("#6366f1") // Indigo default
  order          Int
  probability    Int          @default(0) // 0-100% probability of close

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  deals          Deal[]

  @@unique([organizationId, order])
  @@index([organizationId])
  @@map("pipeline_stages")
}

model Deal {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  title          String
  value          Decimal       @default(0) @db.Decimal(12, 2)
  currency       String        @default("USD")

  // Pipeline
  stageId        String
  stage          PipelineStage @relation(fields: [stageId], references: [id])
  order          Int           @default(0) // Order within stage for drag & drop

  // Dates
  expectedCloseDate DateTime?
  closedAt       DateTime?

  // Status
  status         DealStatus    @default(OPEN)
  lostReason     String?

  // Relations
  clientId       String?
  client         Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)

  creatorId      String
  creator        User          @relation("DealCreator", fields: [creatorId], references: [id])

  // Metadata
  notes          String?
  customData     Json?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  activities     Activity[]

  @@index([organizationId])
  @@index([organizationId, stageId])
  @@index([organizationId, status])
  @@index([clientId])
  @@map("deals")
}

enum DealStatus {
  OPEN
  WON
  LOST
}

model Project {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  name           String
  description    String?
  type           ProjectType  @default(OTHER)

  // Status & Progress
  status         ProjectStatus @default(NOT_STARTED)
  progress       Int           @default(0) // 0-100%
  healthStatus   String?       // healthy, warning, critical (calculated dynamically)

  // Dates
  startDate      DateTime?
  deadline       DateTime?
  completedAt    DateTime?

  // Budget
  budget         Decimal?      @db.Decimal(12, 2)
  spent          Decimal       @default(0) @db.Decimal(12, 2)
  currency       String        @default("USD")

  // Developer fields (CRMDev)
  repoUrl        String?
  wpUrl          String?       // WordPress site URL for monitoring
  vercelUrl      String?       // Vercel app URL for monitoring
  techStack      String[]      @default([])
  labels         String[]      @default([])

  // Relations
  clientId       String?
  client         Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)

  wpMonitor      WpMonitor?    // WordPress monitoring data

  tasks          Task[]
  activities     Activity[]
  projectMembers ProjectMember[]
  tickets        Ticket[]

  // Metadata
  customData     Json?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([clientId])
  @@map("projects")
}

enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectType {
  GITHUB
  WORDPRESS
  VERCEL
  OTHER
}

// ===========================================
// PROJECT MEMBERS (Control de acceso por proyecto)
// ===========================================

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   @default("member") // lead, member, viewer
  createdAt DateTime @default(now())

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

// ===========================================
// WORDPRESS MONITORING (CRMDev)
// Monitoreo de sitios WordPress - health, updates, vulnerabilities
// ===========================================

model WpMonitor {
  id              String   @id @default(cuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // WP Connection (encrypted - store application password/token)
  wpApiKey        String?  // Application password for WP REST API auth

  // Health Status
  lastCheck       DateTime?
  uptimeStatus    String?  // up, down, unknown
  uptimePercent   Float?   @default(100)

  // WordPress Version
  wpVersion       String?
  wpUpdateAvailable Boolean @default(false)

  // PHP Version
  phpVersion      String?
  phpUpdateAvailable Boolean @default(false)

  // Plugins
  pluginUpdates   Int      @default(0)
  totalPlugins    Int      @default(0)
  vulnerablePlugins Json?  // Array of {name, version, vulnerability}

  // Themes
  themeUpdates    Int      @default(0)
  totalThemes     Int      @default(0)
  vulnerableThemes Json?   // Array of {name, version, vulnerability}

  // SSL Certificate
  sslValid        Boolean?
  sslExpiresAt    DateTime?

  // Performance (cached from latest check)
  responseTime    Int?     // ms
  pageSize        Float?   // KB

  // Last error if any
  lastError       String?
  lastErrorAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
  @@map("wp_monitors")
}

model Task {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Basic Info
  title          String
  description    String?

  // Status
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)

  // Dates
  dueDate        DateTime?
  completedAt    DateTime?

  // Time tracking
  estimatedHours Float?
  actualHours    Float?

  // GitHub Integration fields (CRMDev)
  githubIssueNumber Int?
  githubRepoFullName String?
  issueUrl       String?
  prUrl          String?
  labels         String[]     @default([])
  commitHash     String?

  // Relations
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  assigneeId     String?
  assignee       User?        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  creatorId      String
  creator        User         @relation("TaskCreator", fields: [creatorId], references: [id])

  // Hierarchy (subtasks)
  parentId       String?
  parent         Task?        @relation("TaskSubtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks       Task[]       @relation("TaskSubtasks")

  // Order for drag & drop
  order          Int          @default(0)

  // Time entries
  timeEntries    TimeEntry[]

  // Metadata
  tags           String[]     @default([])
  customData     Json?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, assigneeId])
  @@index([projectId])
  @@index([parentId])
  @@index([githubRepoFullName, githubIssueNumber])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ===========================================
// TIME TRACKING (CRMDev)
// ===========================================

model TimeEntry {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Time data
  description    String?
  startTime      DateTime
  endTime        DateTime?
  duration       Int          @default(0)  // in minutes
  billable       Boolean      @default(true)

  // Relations
  taskId         String
  task           Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId         String
  user           User         @relation(fields: [userId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([taskId])
  @@index([userId])
  @@index([organizationId, userId])
  @@map("time_entries")
}

model CustomField {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Field definition
  name           String
  label          String
  type           FieldType    @default(TEXT)
  required       Boolean      @default(false)
  options        Json?        // For SELECT type: ["option1", "option2"]
  defaultValue   String?

  // Which entity this field applies to
  entityType     EntityType

  // Order for display
  order          Int          @default(0)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, entityType, name])
  @@index([organizationId])
  @@map("custom_fields")
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  URL
  EMAIL
  PHONE
  TEXTAREA
}

enum EntityType {
  CLIENT
  DEAL
  PROJECT
  TASK
}

model Activity {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Activity type
  type           ActivityType
  title          String
  description    String?

  // Metadata (JSON for flexibility)
  metadata       Json?

  // Relations (polymorphic - one of these will be set)
  clientId       String?
  client         Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  dealId         String?
  deal           Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)

  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  ticketId       String?
  ticket         Ticket?      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Who performed the activity
  userId         String
  user           User         @relation(fields: [userId], references: [id])

  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([organizationId, type])
  @@index([clientId])
  @@index([dealId])
  @@index([projectId])
  @@index([ticketId])
  @@map("activities")
}

enum ActivityType {
  NOTE
  CALL
  EMAIL
  MEETING
  TASK_COMPLETED
  DEAL_CREATED
  DEAL_WON
  DEAL_LOST
  DEAL_STAGE_CHANGED
  CLIENT_CREATED
  PROJECT_CREATED
  PROJECT_COMPLETED
  // GitHub Integration (CRMDev)
  PR_MERGED
  ISSUE_OPENED
  ISSUE_CLOSED
  DEPLOYMENT
  COMMIT_PUSHED
  TIME_LOGGED
  TICKET_CREATED
  TICKET_UPDATED
}

// ===========================================
// CLIENT SUPPORT TICKETS (CRMDev)
// Client Support Hub - Tickets from clients
// ===========================================

model Ticket {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Client info (guest tickets from non-users)
  guestName      String
  guestEmail     String
  clientId       String?
  client         Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  // Ticket details
  title          String
  description    String       @db.Text
  category       TicketCategory
  priority       TicketPriority @default(MEDIUM)
  status         TicketStatus   @default(OPEN)

  // Project context (optional)
  projectId      String?
  project        Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Attachments (stored as URLs in Vercel Blob or similar)
  attachments    String[]     @default([])

  // AI Analysis (from OpenAI/Grok)
  aiCategory     TicketCategory? // AI-suggested category
  aiPriority     TicketPriority? // AI-suggested priority
  aiSummary      String?       // AI-generated summary
  aiSuggestedFix String?       @db.Text // AI-suggested solution
  confidence     Float?        // AI confidence score (0-1)

  // Auto-reply sent to client
  autoReplySent  Boolean      @default(false)
  autoReplyAt    DateTime?

  // Resolution
  resolution     String?      @db.Text
  resolvedAt     DateTime?
  resolvedBy     String?      // User ID who resolved

  // Metadata
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  comments       TicketComment[]
  activities     Activity[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, priority])
  @@index([guestEmail])
  @@index([clientId])
  @@index([projectId])
  @@map("tickets")
}

enum TicketCategory {
  BUG
  FEATURE_REQUEST
  QUESTION
  SUPPORT
  BILLING
  PERFORMANCE
  SECURITY
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CLIENT
  RESOLVED
  CLOSED
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  content    String   @db.Text
  isInternal Boolean  @default(false) // true = internal note, false = visible to client

  // Author can be a user (dev) or guest info (client)
  authorId   String?
  author     User?    @relation("TicketCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  guestName  String?  // For client comments
  guestEmail String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ticketId])
  @@index([authorId])
  @@map("ticket_comments")
}

// ===========================================
// BILLING / SUBSCRIPTION
// Integraci√≥n con Stripe
// ===========================================

model Subscription {
  id                   String       @id @default(cuid())
  organizationId       String       @unique
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeCustomerId     String       @unique
  stripeSubscriptionId String?      @unique
  stripePriceId        String?

  // Status
  status               SubscriptionStatus @default(TRIALING)

  // Plan limits
  plan                 PlanType     @default(FREE)

  // Billing period
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean      @default(false)

  // Trial
  trialStart           DateTime?
  trialEnd             DateTime?

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([stripeCustomerId])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}
